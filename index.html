<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADOL - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #ffffff;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 414px;
            margin: 0 auto;
            background: #fff;
            position: relative;
        }

        /* Header Section */
        .header {
            padding: 20px 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            position: relative;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 10px;
            align-self: flex-start;
        }

        .logo {
            width: 32px;
            height: 32px;
            background: #4A90E2;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .app-name {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .calendar-container {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .calendar-nav {
            width: 40px;
            height: 40px;
            background: #f3f4f6;
            border: 1px solid #ecedef;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #4A90E2;
            transition: all 0.3s;
        }

        .calendar-nav:hover {
            background: #e8f4fd;
        }

        .calendar-nav:disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .calendar-display {
            width: 100%;
            max-width: 250px;
            height: 44px;
            background: #f3f4f6;
            border: 1px solid #ecedef;
            border-radius: 22px;
            padding: 0 20px;
            font-size: 16px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .calendar-display:hover {
            background: #e8f4fd;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: #1496a4;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(20, 150, 164, 0.3);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: #0f7a85;
            transform: scale(1.05);
        }

        .refresh-icon {
            width: 20px;
            height: 20px;
            position: relative;
        }

        .refresh-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-top: 2px solid transparent;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .refresh-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-left: 4px solid white;
            border-top: 3px solid transparent;
            border-bottom: 3px solid transparent;
            transform: translate(-30%, -50%) rotate(45deg);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Metrics Cards */
        .metrics-section {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            position: relative;
        }

        .metric-card {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #ecedef;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .metric-icon {
            width: 24px;
            height: 24px;
            background: #4A90E2;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            position: relative;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }

        .metric-change {
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .trend-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .trend-icon::before {
            content: '▲';
            color: #28a745;
            font-size: 12px;
            font-weight: bold;
        }

        .metric-change.negative .trend-icon::before {
            content: '▲';
            color: #dc3545;
        }

        .metric-change.positive {
            color: #28a745;
        }

        .metric-change.negative {
            color: #dc3545;
        }

        .trend-icon {
            width: 12px;
            height: 12px;
            background: currentColor;
            border-radius: 2px;
            position: relative;
        }

        .trend-icon::after {
            content: '';
            position: absolute;
            top: -2px;
            left: 2px;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 6px solid currentColor;
        }

        /* Icon Styles - CSS Icons */
        .icon-people::before {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            top: 6px;
            left: 8px;
        }

        .icon-people::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            top: 8px;
            right: 6px;
        }

        .icon-basket::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 8px;
            background: white;
            border-radius: 2px;
            top: 8px;
            left: 6px;
        }

        .icon-basket::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            top: 4px;
            right: 4px;
        }

        .icon-eye::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 8px;
            background: white;
            border-radius: 50%;
            top: 8px;
            left: 6px;
        }

        .icon-eye::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            top: 10px;
            left: 10px;
        }

        .icon-chart::before {
            content: '';
            position: absolute;
            width: 3px;
            height: 8px;
            background: white;
            top: 16px;
            left: 5px;
        }

        .icon-chart::after {
            content: '';
            position: absolute;
            width: 3px;
            height: 12px;
            background: white;
            top: 12px;
            right: 5px;
        }

        /* Navigation Icons */
        .icon-grid::before {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: currentColor;
            top: 4px;
            left: 4px;
            box-shadow: 8px 0 0 currentColor, 0 8px 0 currentColor, 8px 8px 0 currentColor;
        }

        .icon-box::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 10px;
            border: 2px solid currentColor;
            top: 7px;
            left: 6px;
        }

        .icon-box::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            border: 2px solid currentColor;
            border-bottom: none;
            border-right: none;
            top: 3px;
            left: 8px;
        }

        .icon-order::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 8px;
            border: 2px solid currentColor;
            border-radius: 2px;
            top: 8px;
            left: 6px;
        }

        .icon-order::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: currentColor;
            border-radius: 50%;
            top: 4px;
            right: 4px;
        }

        .icon-analytics::before {
            content: '';
            position: absolute;
            width: 2px;
            height: 12px;
            background: currentColor;
            top: 12px;
            left: 5px;
        }

        .icon-analytics::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 8px;
            background: currentColor;
            top: 16px;
            right: 5px;
        }

        .icon-account::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border: 2px solid currentColor;
            border-radius: 50%;
            top: 6px;
            left: 7px;
        }

        .icon-account::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 4px;
            border: 2px solid currentColor;
            border-top: none;
            border-radius: 0 0 8px 8px;
            top: 16px;
            left: 8px;
        }

        /* Overview Chart */
        .overview-section {
            padding: 0 20px 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .overview-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .today-date {
            font-size: 14px;
            color: #666;
            font-weight: 500;
            margin-left: 20%;
        }

        .overview-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .period-selector {
            display: flex;
            gap: 8px;
        }

        .period-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0f0f0;
            color: #666;
        }

        .period-btn.active {
            background: #333;
            color: white;
        }

        .chart-container {
            flex: 1;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            min-height: 200px;
        }

        .chart {
            width: 100%;
            height: 160px;
            display: flex;
            align-items: end;
            justify-content: space-between;
            gap: 8px;
            margin-top: 20px;
        }

        .chart-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .chart-bars {
            display: flex;
            gap: 2px;
            align-items: end;
            height: 120px;
            justify-content: center;
        }

        .chart-bar {
            width: 12px;
            background: #4A90E2;
            border-radius: 2px 2px 0 0;
        }

        .chart-bar.secondary {
            background: #87CEEB;
            opacity: 0.8;
        }

        .chart-label {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .y-axis {
            position: absolute;
            left: 20px;
            top: 40px;
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 12px;
            color: #999;
        }

        /* Navigation Bar */
        .navigation {
            position: fixed;
            bottom: 1%;
            left: 0;
            right: 0;
            background: #fff;
            border-top: none;
            padding: 6px 0 2px;
            display: flex;
            justify-content: space-around;
            z-index: 1000;
            align-items: center;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav-item.active {
            color: #4A90E2;
        }

        .nav-item:not(.active) {
            color: #999;
        }

        .nav-icon {
            width: 31px;
            height: 31px;
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }

        /* Responsive adjustments */
        @media (max-width: 375px) {
            .metrics-section {
                padding: 15px;
                gap: 12px;
            }
            
            .metric-card {
                padding: 15px;
            }
            
            .metric-value {
                font-size: 24px;
            }
        }

        /* Loading Spinner Styles */
        .metric-card {
            position: relative;
        }

        .card-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border-radius: 12px;
        }

        .card-loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .card-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4A90E2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dark mode spinner */
        .dark-mode .card-loading-overlay {
            background: #2a2a2a;
        }

        .dark-mode .card-spinner {
            border: 2px solid #333;
            border-top: 2px solid #4A90E2;
        }

        /* Today Stats Styles */

        .today-stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: -4%;
        }

        .today-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .today-stat-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .today-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1496a4;
            margin-bottom: 5px;
        }

        .today-stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .today-stat-change {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            background: #e0f4f7;
            color: #1496a4;
            display: inline-block;
        }

        /* Dark mode for today stats */
        .dark-mode .today-stat-card {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .dark-mode .today-stat-value {
            color: #1496a4;
        }

        .dark-mode .today-stat-label {
            color: #ccc;
        }

        .dark-mode .today-stat-change {
            background: #1a1a1a;
            color: #1496a4;
        }

        .dark-mode .today-date {
            color: #ccc;
        }

        /* Top Users Section */
        .top-users-section {
            position: fixed;
            top: 75%;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 0;
            margin-top: -3%;
        }

        .see-all-link {
            color: #4A90E2;
            text-decoration: none;
            font-weight: 500;
            font-size: 16px;
            margin-top: -3%;
        }

        .see-all-link:hover {
            text-decoration: underline;
        }

        .users-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .user-card {
            display: flex;
            align-items: center;
            padding: 7px;
            background: #e9ecef;
            border-radius: 12px;
            gap: 7px;
            min-height: 42px;
            margin-top: -3%;
        }

        .user-avatar {
            width: 33px;
            height: 33px;
            flex-shrink: 0;
        }

        .avatar-placeholder {
            width: 100%;
            height: 100%;
            background: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #666;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 13px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .user-specialty {
            font-size: 11px;
            color: #666;
            margin: 0;
        }

        .user-rating {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .star {
            display: inline-block;
            width: 16px;
            height: 16px;
        }

        .star img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .rating {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .reviews {
            font-size: 12px;
            color: #666;
        }

        .user-availability {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .time-slot {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .contact-btn {
            background: #FF6B35;
            color: white;
            border: none;
            padding: 5px 9px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }

        .contact-btn:hover {
            background: #E55A2B;
        }

        /* Dark mode for top users */
        .dark-mode .top-users-section {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .dark-mode .section-title {
            color: #e0e0e0;
        }

        .dark-mode .user-card {
            background: #3a3a3a;
        }

        .dark-mode .user-name {
            color: #e0e0e0;
        }

        .dark-mode .user-specialty,
        .dark-mode .reviews,
        .dark-mode .time-slot {
            color: #ccc;
        }

        .dark-mode .avatar-placeholder {
            background: #4a4a4a;
            color: #ccc;
        }

        /* Users Overlay */
        .users-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 500;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .users-overlay.show {
            display: flex;
        }

        .users-modal {
            background: white;
            border-radius: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .users-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 16px 24px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .users-modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .close-overlay {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-overlay:hover {
            background: #f0f0f0;
        }

        .users-list-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 16px 24px 24px 24px;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .user-overlay-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .user-overlay-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .user-overlay-avatar {
            width: 48px;
            height: 48px;
            flex-shrink: 0;
        }

        .user-overlay-avatar .avatar-placeholder {
            width: 100%;
            height: 100%;
            background: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
            font-weight: bold;
        }

        .user-overlay-info {
            flex: 1;
            min-width: 0;
        }

        .user-overlay-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin: 0 0 4px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-overlay-specialty {
            font-size: 14px;
            color: #666;
            margin: 0 0 8px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-overlay-rating {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .user-overlay-star {
            display: inline-block;
            width: 16px;
            height: 16px;
        }

        .user-overlay-star img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .user-overlay-rating-text {
            font-size: 12px;
            color: #888;
        }

        .user-overlay-availability {
            text-align: right;
            flex-shrink: 0;
        }

        .user-overlay-time {
            font-size: 12px;
            color: #666;
            margin: 0 0 8px 0;
        }

        .user-overlay-button {
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }

        .user-overlay-button:hover {
            background: #E55A2B;
        }

        /* Dark mode for overlay */
        .dark-mode .users-overlay {
            background: rgba(0, 0, 0, 0.9);
        }

        .dark-mode .users-modal {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .dark-mode .users-modal-title {
            color: #e0e0e0;
        }

        .dark-mode .users-modal-header {
            border-bottom: 1px solid #444;
        }

        .dark-mode .close-overlay {
            color: #ccc;
        }

        .dark-mode .close-overlay:hover {
            background: #3a3a3a;
        }

        .dark-mode .user-overlay-card {
            background: #3a3a3a;
        }

        .dark-mode .user-overlay-name {
            color: #e0e0e0;
        }

        .dark-mode .user-overlay-specialty {
            color: #ccc;
        }

        .dark-mode .user-overlay-time {
            color: #ccc;
        }

        .dark-mode .user-overlay-rating-text {
            color: #aaa;
        }

        /* User Detail Modal */
        .user-detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 500;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .user-detail-overlay.show {
            display: flex;
        }

        .user-detail-modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .user-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-detail-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .close-detail {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-detail:hover {
            background: #f0f0f0;
        }

        .user-detail-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .user-detail-avatar {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .user-detail-avatar .avatar-placeholder {
            width: 80px;
            height: 80px;
            background: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #666;
            font-weight: bold;
        }

        .user-detail-info {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .user-detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-detail-label {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-detail-value {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .user-detail-email {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .user-detail-email-value {
            font-size: 16px;
            color: #333;
            font-weight: 500;
            font-family: monospace;
            flex: 1;
            word-break: break-all;
        }

        .copy-email-btn {
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .copy-email-btn:hover {
            background: #357ABD;
        }

        .copy-email-btn.copied {
            background: #28a745;
        }

        /* Dark mode for user detail modal */
        .dark-mode .user-detail-modal {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .dark-mode .user-detail-title {
            color: #e0e0e0;
        }

        .dark-mode .user-detail-header {
            border-bottom: 1px solid #444;
        }

        .dark-mode .close-detail {
            color: #ccc;
        }

        .dark-mode .close-detail:hover {
            background: #3a3a3a;
        }

        .dark-mode .user-detail-label {
            color: #ccc;
        }

        .dark-mode .user-detail-value {
            color: #e0e0e0;
        }

        .dark-mode .user-detail-email {
            background: #3a3a3a;
        }

        .dark-mode .user-detail-email-value {
            color: #e0e0e0;
        }

        .dark-mode .user-detail-avatar .avatar-placeholder {
            background: #4a4a4a;
            color: #ccc;
        }

        /* Impressions Overlay */
        .impressions-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 500;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .impressions-overlay.show {
            display: flex;
        }

        .impressions-modal {
            background: white;
            border-radius: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .impressions-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 16px 24px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .impressions-modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .impressions-content {
            padding: 24px;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .impressions-header {
            margin-bottom: 30px;
        }

        .impressions-header h3 {
            font-size: 16px;
            font-weight: 500;
            color: #666;
            margin: 0 0 8px 0;
        }

        .total-amount {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .impressions-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .impression-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            min-height: 60px;
        }

        .impression-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .card-icon img {
            width: 24px;
            height: 24px;
            filter: brightness(0) invert(1);
        }

        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .card-label {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin: 0;
        }

        .card-value {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .card-arrow {
            font-size: 18px;
            color: #999;
            font-weight: bold;
        }

        /* Dark mode for impressions overlay */
        .dark-mode .impressions-modal {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .dark-mode .impressions-modal-title {
            color: #e0e0e0;
        }

        .dark-mode .impressions-modal-header {
            background: #2a2a2a;
            border-bottom: 1px solid #444;
        }

        .dark-mode .impressions-header h3 {
            color: #ccc;
        }

        .dark-mode .total-amount {
            color: #e0e0e0;
        }

        .dark-mode .impression-card {
            background: #3a3a3a;
        }

        .dark-mode .card-icon {
            background: #555;
        }

        .dark-mode .card-label {
            color: #e0e0e0;
        }

        .dark-mode .card-value {
            color: #ccc;
        }

        .dark-mode .card-arrow {
            color: #aaa;
        }

        .dark-mode .user-overlay-name {
            color: #e0e0e0;
        }

        /* Downloads Overlay */
        .downloads-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 500;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .downloads-overlay.show {
            display: flex;
        }

        .downloads-modal {
            background: white;
            border-radius: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .downloads-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 16px 24px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .downloads-modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .downloads-content {
            padding: 24px;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .downloads-header {
            margin-bottom: 30px;
        }

        .downloads-header h3 {
            font-size: 16px;
            font-weight: 500;
            color: #666;
            margin: 0 0 8px 0;
        }

        .downloads-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .download-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            min-height: 60px;
        }

        .download-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .download-action {
            cursor: pointer;
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        .download-action:hover {
            background: #e8e8e8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .download-action .card-label {
            color: #333;
        }

        .download-action .card-value {
            color: #666;
        }

        .download-action .card-arrow {
            color: #666;
            font-size: 18px;
        }

        .download-action .download-icon {
            width: 24px;
            height: 24px;
            background: #333;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .download-action .download-icon::before {
            content: '';
            width: 12px;
            height: 8px;
            background: white;
            border-radius: 2px;
            position: relative;
        }

        .download-action .download-icon::after {
            content: '';
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 6px solid white;
        }

        /* Dark mode for downloads overlay */
        .dark-mode .downloads-modal {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .dark-mode .downloads-modal-title {
            color: #e0e0e0;
        }

        .dark-mode .downloads-modal-header {
            background: #2a2a2a;
            border-bottom: 1px solid #444;
        }

        .dark-mode .downloads-header h3 {
            color: #ccc;
        }

        .dark-mode .download-card {
            background: #3a3a3a;
        }

        .dark-mode .download-action {
            background: #4a4a4a;
            border: 1px solid #666;
        }

        .dark-mode .download-action:hover {
            background: #555;
        }

        .dark-mode .download-action .card-label {
            color: #e0e0e0;
        }

        .dark-mode .download-action .card-value {
            color: #ccc;
        }

        .dark-mode .download-action .card-arrow {
            color: #ccc;
        }

        .dark-mode .download-action .download-icon {
            background: #e0e0e0;
        }

        /* Download Modal */
        .download-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .download-modal-overlay.show {
            display: flex;
        }

        .download-modal {
            background: white;
            border-radius: 16px;
            padding: 0;
            width: 90%;
            max-width: 500px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .download-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 16px 24px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
        }

        .download-modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .download-modal-content {
            padding: 24px;
        }
        .download-modal-footer {
            padding: 16px 24px 24px 24px;
            display: flex;
            justify-content: flex-end;
        }
        .download-close-btn {
            padding: 10px 16px;
            background: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .download-close-btn:hover {
            background: #d5d5d5;
        }

        .download-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .download-option {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }

        .download-option:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .download-option.copied {
            background: #d4edda !important;
            transition: background 0.3s ease;
        }

        .option-icon {
            width: 40px;
            height: 40px;
            background: #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .copy-icon {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 2px;
            position: relative;
        }

        .copy-icon::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 12px;
            background: #333;
            border-radius: 1px;
        }

        .copy-icon::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 10px;
            height: 8px;
            background: white;
            border-radius: 1px;
        }

        .option-content {
            flex: 1;
        }

        .option-label {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0 0 4px 0;
        }

        .option-description {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .option-arrow {
            font-size: 18px;
            color: #999;
            font-weight: bold;
        }


        /* Dark mode for download modal */
        .dark-mode .download-modal {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .dark-mode .download-modal-title {
            color: #e0e0e0;
        }

        .dark-mode .download-modal-header {
            background: #2a2a2a;
            border-bottom: 1px solid #444;
        }

        .dark-mode .download-option {
            background: #3a3a3a;
            border: 1px solid #555;
        }

        .dark-mode .download-option:hover {
            background: #4a4a4a;
        }

        .dark-mode .option-label {
            color: #e0e0e0;
        }

        .dark-mode .option-description {
            color: #ccc;
        }


        /* Account Overlay */
        .account-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 500;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .account-overlay.show {
            display: flex;
        }

        .account-modal {
            background: white;
            border-radius: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .account-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 16px 24px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .account-modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .account-content {
            padding: 24px;
            height: calc(100vh - 80px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .account-profile {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 0 auto;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 16px;
            max-width: 300px;
            justify-content: center;
        }

        .support-message {
            margin: 30px auto 0;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 16px;
            max-width: 320px;
            text-align: center;
            border-left: 4px solid #4A90E2;
        }

        .support-message h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
            font-size: 16px;
            font-weight: 600;
        }

        .support-message p {
            margin: 0;
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: #4A90E2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .profile-avatar .avatar-placeholder {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #4A90E2;
        }

        .profile-avatar .avatar-placeholder::before {
            content: "A";
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 0 0 8px 0;
        }

        .profile-role {
            font-size: 16px;
            color: #4A90E2;
            margin: 0 0 4px 0;
            font-weight: 500;
        }

        .profile-email {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .account-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .account-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            min-height: 60px;
        }

        .account-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Dark mode for account overlay */
        .dark-mode .account-modal {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .dark-mode .account-modal-title {
            color: #e0e0e0;
        }

        .dark-mode .account-modal-header {
            background: #2a2a2a;
            border-bottom: 1px solid #444;
        }

        .dark-mode .account-profile {
            background: #3a3a3a;
        }

        .dark-mode .profile-name {
            color: #e0e0e0;
        }

        .dark-mode .profile-role {
            color: #4A90E2;
        }

        .dark-mode .profile-email {
            color: #ccc;
        }

        .dark-mode .account-card {
            background: #3a3a3a;
        }

        .dark-mode .users-modal-header {
            background: #2a2a2a;
        }

        .dark-mode .user-overlay-email {
            color: #ccc;
        }

        .dark-mode .user-overlay-stats {
            color: #aaa;
        }

        .dark-mode .user-overlay-avatar .avatar-placeholder {
            background: #4a4a4a;
            color: #ccc;
        }

    </style>
</head>
<body>
    <!-- Top Users Section -->
    <div class="top-users-section">
        <div class="section-header">
            <h2 class="section-title">Usuario Destacado</h2>
            <a href="#" class="see-all-link" onclick="showUsersOverlay(); return false;">Ver todos</a>
        </div>
        
        <div class="users-list">
            <div class="user-card">
                <div class="user-avatar">
                    <div class="avatar-placeholder"></div>
                </div>
                <div class="user-info">
                    <h3 class="user-name" id="top-user-name">Cargando...</h3>
                    <p class="user-specialty" id="top-user-type">Analizando datos...</p>
                    <div class="user-rating">
                        <span class="star"><img src="images/estrella.png" alt="⭐"></span>
                        <div class="rating-info">
                            <span class="rating" id="top-user-score">0</span>
                            <span class="reviews" id="top-user-usage">(0 usos)</span>
                        </div>
                    </div>
                </div>
                <div class="user-availability">
                    <div class="time-slot" id="top-user-status">Disponible</div>
                            <button class="contact-btn" onclick="contactTopUser()">Contactar</button>
                </div>
            </div>
        </div>
    </div>

    <img src="images/s.png" alt="ADOL" class="top-logo" style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); height: 47px; width: auto; z-index: 400;">
    
    <div class="container">

        <!-- Header Section -->
        <div class="header">
            <button class="theme-toggle" onclick="refreshData()" title="Actualizar datos">
                <div class="refresh-icon"></div>
            </button>
            
            <div class="logo-section">
                <div class="invisible-logo" style="height: 40px; width: 40px; visibility: hidden;"></div>
            </div>
            
            <div class="calendar-container">
                <button class="calendar-nav" id="prev-month">‹</button>
                <div class="calendar-display" id="current-month">Octubre 2025</div>
                <button class="calendar-nav" id="next-month">›</button>
            </div>
        </div>

        <!-- Metrics Cards -->
        <div class="metrics-section">
            <div class="metric-card">
                <div class="card-loading-overlay" id="loading-visitors">
                    <div class="card-spinner"></div>
                </div>
                <div class="metric-value" id="total-visitors">...</div>
                <div class="metric-label">Usuarios Registrados</div>
                <div class="metric-change positive">
                    <span id="visitors-change">...</span>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="card-loading-overlay" id="loading-orders">
                    <div class="card-spinner"></div>
                </div>
                <div class="metric-value" id="total-orders">...</div>
                <div class="metric-label">Impresiones</div>
                <div class="metric-change positive">
                    <span id="orders-change">...</span>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="card-loading-overlay" id="loading-views">
                    <div class="card-spinner"></div>
                </div>
                <div class="metric-value" id="total-views">...</div>
                        <div class="metric-label">Controles en la App</div>
                <div class="metric-change negative">
                    <span id="views-change">...</span>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="card-loading-overlay" id="loading-conversion">
                    <div class="card-spinner"></div>
                </div>
                <div class="metric-value" id="conversion-rate">...</div>
                <div class="metric-label">Entradas a la App</div>
                <div class="metric-change positive">
                    <span id="conversion-change">...</span>
                </div>
            </div>
        </div>

        <!-- Vistas Hoy Section -->
        <div class="overview-section">
            <div class="overview-header">
                <div class="overview-title">Vistas Hoy</div>
                <div class="today-date" id="today-date"></div>
            </div>
            
            <div class="today-stats-container">
            <div class="today-stat-card">
                <div class="today-stat-value" id="today-views">0</div>
                <div class="today-stat-label">Entradas al App Hoy</div>
                <div class="today-stat-change" id="today-views-change">+0%</div>
            </div>
            
            <div class="today-stat-card">
                <div class="today-stat-value" id="today-users">0</div>
                <div class="today-stat-label">Impresiones Hoy</div>
                <div class="today-stat-change" id="today-users-change">+0%</div>
            </div>
            </div>
        </div>

        <!-- Navigation Bar -->
        <div class="navigation">
            <div class="nav-item active" onclick="goToHome()">
                <div class="nav-icon"><img src="images/icon4_00000.png" alt="Inicio"></div>
                <div class="nav-label">Inicio</div>
            </div>
            <div class="nav-item" onclick="showUsersOverlay()">
                <div class="nav-icon"><img src="images/icon5_00000.png" alt="Usuarios"></div>
                <div class="nav-label">Usuarios</div>
            </div>
            <div class="nav-item" onclick="showImpressionsOverlay()">
                <div class="nav-icon"><img src="images/icon3_00000.png" alt="Impresiones"></div>
                <div class="nav-label">Impresiones</div>
            </div>
            <div class="nav-item" onclick="showDownloadsOverlay()">
                <div class="nav-icon"><img src="images/icon1_00000.png" alt="Descargas"></div>
                <div class="nav-label">Descargas</div>
            </div>
            <div class="nav-item" onclick="showAccountOverlay()">
                <div class="nav-icon"><img src="images/icon2_00000.png" alt="Cuenta"></div>
                <div class="nav-label">Cuenta</div>
            </div>
        </div>
    </div>

    <!-- Users Overlay -->
    <div class="users-overlay" id="users-overlay">
        <div class="users-modal">
            <div class="users-modal-header">
                <h2 class="users-modal-title">Todos los Usuarios</h2>
                <button class="close-overlay" onclick="hideUsersOverlay()">&times;</button>
            </div>
            <div class="users-list-container" id="users-list">
                <!-- Users will be populated here -->
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div class="user-detail-overlay" id="user-detail-overlay">
        <div class="user-detail-modal">
            <div class="user-detail-header">
                <h2 class="user-detail-title">Información del Usuario</h2>
                <button class="close-detail" onclick="hideUserDetail()">&times;</button>
            </div>
            <div class="user-detail-content" id="user-detail-content">
                <!-- User details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Impressions Overlay -->
    <div class="impressions-overlay" id="impressions-overlay">
        <div class="impressions-modal">
            <div class="impressions-modal-header">
                <h2 class="impressions-modal-title">Impresiones</h2>
                <button class="close-overlay" onclick="hideImpressionsOverlay()">&times;</button>
            </div>
            <div class="impressions-content" id="impressions-content">
                <div class="impressions-header">
                    <h3>Total Impresiones</h3>
                    <div class="total-amount" id="total-impressions">0</div>
                </div>
                
                <div class="impressions-cards">
                    <div class="impression-card">
                        <div class="card-icon">
                            <img src="images/icon3_00000.png" alt="Impresiones">
                        </div>
                        <div class="card-content">
                            <div class="card-label">Impresiones</div>
                            <div class="card-value" id="impressions-month">0</div>
                        </div>
                        <div class="card-arrow">›</div>
                    </div>
                    
                    <div class="impression-card">
                        <div class="card-icon">
                            <img src="images/icon3_00000.png" alt="Hoy">
                        </div>
                        <div class="card-content">
                            <div class="card-label">Hoy</div>
                            <div class="card-value" id="impressions-today">0</div>
                        </div>
                        <div class="card-arrow">›</div>
                    </div>
                    
                    <div class="impression-card">
                        <div class="card-icon">
                            <img src="images/icon3_00000.png" alt="Semana">
                        </div>
                        <div class="card-content">
                            <div class="card-label">Esta Semana</div>
                            <div class="card-value" id="impressions-week">0</div>
                        </div>
                        <div class="card-arrow">›</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Downloads Overlay -->
    <div class="downloads-overlay" id="downloads-overlay">
        <div class="downloads-modal">
            <div class="downloads-modal-header">
                <h2 class="downloads-modal-title">Descargas</h2>
                <button class="close-overlay" onclick="hideDownloadsOverlay()">&times;</button>
            </div>
            <div class="downloads-content" id="downloads-content">
                <div class="downloads-cards">
                    <div class="download-card download-action" onclick="showDownloadModal()">
                        <div class="download-icon"></div>
                        <div class="card-content">
                            <div class="card-label">Base de usuarios registrados</div>
                            <div class="card-value">Descargar CSV</div>
                        </div>
                        <div class="card-arrow">›</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div class="download-modal-overlay" id="download-modal-overlay">
        <div class="download-modal">
            <div class="download-modal-header">
                <h2 class="download-modal-title">Descargar Base de Datos</h2>
            </div>
            <div class="download-modal-content">
                <div class="download-options">
                    <div class="download-option" onclick="copyDownloadLink()">
                        <div class="option-icon">
                            <div class="copy-icon"></div>
                        </div>
                        <div class="option-content">
                            <div class="option-label">Copiar enlace</div>
                            <div class="option-description">Copia el enlace para compartir</div>
                        </div>
                        <div class="option-arrow">›</div>
                    </div>
                    
                    <div class="download-option" onclick="downloadDirectly()">
                        <div class="option-icon">
                            <div class="download-icon"></div>
                        </div>
                        <div class="option-content">
                            <div class="option-label">Descargar aquí</div>
                            <div class="option-description">Descarga directa al dispositivo</div>
                        </div>
                        <div class="option-arrow">›</div>
                    </div>
                </div>
                <div class="download-modal-footer">
                    <button class="download-close-btn" onclick="hideDownloadModal()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Overlay -->
    <div class="account-overlay" id="account-overlay">
        <div class="account-modal">
            <div class="account-modal-header">
                <h2 class="account-modal-title">Mi Cuenta</h2>
                <button class="close-overlay" onclick="hideAccountOverlay()">&times;</button>
            </div>
            <div class="account-content" id="account-content">
                <div class="account-profile">
                    <div class="profile-avatar">
                        <div class="avatar-placeholder"></div>
                    </div>
                    <div class="profile-info">
                        <h3 class="profile-name">Admin</h3>
                        <p class="profile-role">Administrador del Sistema</p>
                        <p class="profile-email">admin@sistema.com</p>
                    </div>
                </div>
                
                <div class="support-message">
                    <h4>Grupo Codex</h4>
                    <p>¿Necesitas ayuda o tienes algún problema?<br>Contáctanos en nuestro grupo de soporte para asistencia técnica.</p>
                </div>
                
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbx7A63ndzuoQYP1nExS_dCSLAzNXbVbKR0YgrZZjFtocRhuZA-KBvPfzgVW6lcpudlR/exec';
        const API_VIEWS_ORDERS_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhlQZ6KlfZoYMeHKHAHBTOyv3CZKhAJq1S00nl1jQHkKiMttZ6LOKcaYHtTeC5pCdnvcZBannzicbg9DnNAOAQzacVYQ1exUDC_5SPsb6WxT8gvwzn44bXKCezXg3VOiE86n4E0JHC_vMzPCykhHZA3fBp-mX4sZs2MWxl7r9zl-rZ4UrTmEbkEh3Rv2gXBZ555D_W2mS7RSsiL6yymVWQwEg-r18Mrre2TpDJl4e5gjXluQ6FQ-0IkIUpUpNHTkxieG40J8lRpdh2ykDiuEI2Nxz4LlA&lib=MwcvG3hwhfwRgs0aJa79VtIzpTaZOijRF';
        const API_IMPRESSIONS_URL = 'https://script.google.com/macros/s/AKfycbw0w7yG8dsGPSuXppP__zw0xFhMhuxCAqJ2zcmOf2oc5rQUoKsI9uQyA1gBEZKWydrrLw/exec';

        // Calendar state
        let currentSelectedDate = new Date();
        let availableMonths = new Set();

        // Global variables for storing API data
        let allViewsData = [];
        let allImpressionsData = []; // datos crudos desde API_IMPRESSIONS_URL

        // Users Overlay Functions
        function showUsersOverlay() {
            // Close all other overlays first
            hideUserDetail();
            hideImpressionsOverlay();
            hideDownloadsOverlay();
            hideAccountOverlay();
            
            document.getElementById('users-overlay').classList.add('show');
            
            // Only load users if not already cached
            if (!cachedUsersData) {
                populateUsersGrid();
            }
        }

        function hideUsersOverlay() {
            document.getElementById('users-overlay').classList.remove('show');
        }

        // Variable global para cachear los usuarios
        let cachedUsersData = null;

        // Función para limpiar el cache y recargar usuarios
        function refreshUsersData() {
            cachedUsersData = null;
            populateUsersGrid();
        }

        async function populateUsersGrid() {
            const usersList = document.getElementById('users-list');
            
            // Si ya tenemos datos cacheados, usarlos directamente
            if (cachedUsersData) {
                renderUsersGrid(cachedUsersData);
                return;
            }

            // Solo mostrar "Cargando..." si no hay datos cacheados
            usersList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Cargando usuarios...</p>';

            try {
                // Use the same API as "Usuarios Registrados"
                const response = await fetch(API_URL);
                const result = await response.json();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    usersList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay usuarios registrados</p>';
                    return;
                }

                const registeredUsers = result.data;
                // Cachear los datos para futuras aperturas
                cachedUsersData = registeredUsers;
                
                renderUsersGrid(registeredUsers);

            } catch (error) {
                console.error('Error loading users:', error);
                usersList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Error al cargar usuarios</p>';
            }
        }

        function renderUsersGrid(registeredUsers) {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';

            // Group users by email and calculate stats
                const userStatsMap = new Map();

                registeredUsers.forEach(user => {
                const mainEmail = extractMainEmail(user.Correo);
                const usage = user.Uso || 0;
                const name = user.Nombre || 'Usuario Anónimo';
                
                if (userStatsMap.has(mainEmail)) {
                    const existing = userStatsMap.get(mainEmail);
                    existing.totalUsage += usage;
                    existing.records++;
                    // Keep the most recent name if available
                    if (user.Nombre && user.Nombre !== 'Usuario Anónimo') {
                        existing.name = user.Nombre;
                    }
                } else {
                    userStatsMap.set(mainEmail, {
                        name: name,
                        email: mainEmail,
                        totalUsage: usage,
                        records: 1
                    });
                }
            });

            // Convert to array and sort by usage
            const userStatsArray = Array.from(userStatsMap.values()).sort((a, b) => b.totalUsage - a.totalUsage);

            // Create user cards
            userStatsArray.forEach((userStats, index) => {
                const userCard = document.createElement('div');
                userCard.className = 'user-overlay-card';

                let userType = 'Básico';
                let userSpecialty = 'Usuario Básico';
                if (userStats.totalUsage >= 100) {
                    userType = 'Premium';
                    userSpecialty = 'Usuario Premium';
                } else if (userStats.totalUsage >= 50) {
                    userType = 'VIP';
                    userSpecialty = 'Usuario VIP';
                } else if (userStats.totalUsage >= 10) {
                    userType = 'Activo';
                    userSpecialty = 'Usuario Activo';
                }

                // Calculate score (max 5.0, based on usage)
                const score = Math.min(5.0, Math.max(1.0, (userStats.totalUsage / 20) + 1));
                
                // Generate availability times based on index
                const timeSlots = [
                    '10:00 AM - 2:00 PM',
                    '11:00 AM - 3:00 PM', 
                    '2:00 PM - 5:00 PM',
                    '9:00 AM - 1:00 PM',
                    '3:00 PM - 7:00 PM'
                ];
                const timeSlot = timeSlots[index % timeSlots.length];

                // Get first letter of name for avatar
                const firstLetter = userStats.name.charAt(0).toUpperCase();

                // Find the first registration date for this user
                const firstRegistration = registeredUsers
                    .filter(user => extractMainEmail(user.Correo) === userStats.email && user.Fecha)
                    .sort((a, b) => new Date(a.Fecha) - new Date(b.Fecha))[0];
                
                const registrationDate = firstRegistration ? 
                    new Date(firstRegistration.Fecha).toLocaleDateString('es-ES', {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric'
                    }) : 'Fecha no disponible';

                userCard.innerHTML = `
                    <div class="user-overlay-avatar">
                        <div class="avatar-placeholder">${firstLetter}</div>
                    </div>
                    <div class="user-overlay-info">
                        <div class="user-overlay-name">${userStats.name}</div>
                        <div class="user-overlay-specialty">${userStats.email}</div>
                        <div class="user-overlay-rating">
                            <span class="user-overlay-star">
                                <img src="images/estrella.png" alt="⭐">
                            </span>
                            <span class="user-overlay-rating-text">${userStats.totalUsage} Controles</span>
                        </div>
                    </div>
                    <div class="user-overlay-availability">
                        <div class="user-overlay-time">${registrationDate}</div>
                        <button class="user-overlay-button" onclick="showUserDetail('${userStats.name}', '${userStats.email}', ${userStats.totalUsage}, ${userStats.records}, '${registrationDate}')">Contactar</button>
                    </div>
                `;

                usersList.appendChild(userCard);
            });
        }

        // Contact top user function
        function contactTopUser() {
            const topUserName = document.getElementById('top-user-name').textContent;
            const topUserType = document.getElementById('top-user-type').textContent;
            
            // Extract information from the top user card
            if (topUserName && topUserName !== 'Cargando...' && topUserName !== 'Sin datos') {
                // Get the same logic as updateTopUser to find the correct user
                const selectedYear = currentSelectedDate.getFullYear();
                const selectedMonth = currentSelectedDate.getMonth();
                const firstDayOfSelectedMonth = new Date(selectedYear, selectedMonth, 1);
                const lastDayOfSelectedMonth = new Date(selectedYear, selectedMonth + 1, 0);

                const selectedMonthData = allViewsData.filter(user => {
                    if (!user.Fecha || user.Fecha === '') return true; // Include users without date
                    const userDate = new Date(user.Fecha);
                    return userDate >= firstDayOfSelectedMonth && userDate <= lastDayOfSelectedMonth;
                });

                // Calculate usage per user for selected month
                const userUsageMap = new Map();
                
                selectedMonthData.forEach(user => {
                    const mainEmail = extractMainEmail(user.Correo);
                    const usage = user.Uso || 0;
                    
                    if (userUsageMap.has(mainEmail)) {
                        userUsageMap.set(mainEmail, userUsageMap.get(mainEmail) + usage);
                    } else {
                        userUsageMap.set(mainEmail, usage);
                    }
                });

                // Find user with highest usage
                let topUser = null;
                let maxUsage = 0;
                let topUserEmail = '';

                userUsageMap.forEach((usage, email) => {
                    if (usage > maxUsage) {
                        maxUsage = usage;
                        topUserEmail = email;
                    }
                });

                // If no data for selected month, get global top user
                if (maxUsage === 0 || !topUserEmail) {
                    const globalUserUsageMap = new Map();
                    
                    allViewsData.forEach(user => {
                        const mainEmail = extractMainEmail(user.Correo);
                        const usage = user.Uso || 0;
                        
                        if (globalUserUsageMap.has(mainEmail)) {
                            globalUserUsageMap.set(mainEmail, globalUserUsageMap.get(mainEmail) + usage);
                        } else {
                            globalUserUsageMap.set(mainEmail, usage);
                        }
                    });

                    globalUserUsageMap.forEach((usage, email) => {
                        if (usage > maxUsage) {
                            maxUsage = usage;
                            topUserEmail = email;
                        }
                    });

                    if (topUserEmail) {
                        topUser = allViewsData.find(user => extractMainEmail(user.Correo) === topUserEmail);
                    }
                } else {
                    topUser = selectedMonthData.find(user => extractMainEmail(user.Correo) === topUserEmail);
                }

                if (topUser && maxUsage > 0) {
                    // Calculate total records for this user
                    const userRecords = allViewsData.filter(user => extractMainEmail(user.Correo) === topUserEmail).length;
                    
                    // Find registration date
                    const firstRegistration = allViewsData
                        .filter(user => extractMainEmail(user.Correo) === topUserEmail && user.Fecha)
                        .sort((a, b) => new Date(a.Fecha) - new Date(b.Fecha))[0];
                    
                    const registrationDate = firstRegistration ? 
                        new Date(firstRegistration.Fecha).toLocaleDateString('es-ES', {
                            day: 'numeric',
                            month: 'short',
                            year: 'numeric'
                        }) : 'Fecha no disponible';
                    
                    showUserDetail(topUser.Nombre || 'Usuario Anónimo', topUserEmail, maxUsage, userRecords, registrationDate);
                }
            }
        }

        // Show user detail modal
        function showUserDetail(name, email, totalUsage, records, registrationDate) {
            const detailContent = document.getElementById('user-detail-content');
            const firstLetter = name.charAt(0).toUpperCase();
            
            // Determine user type based on usage
            let userType = 'Básico';
            if (totalUsage >= 100) userType = 'Premium';
            else if (totalUsage >= 50) userType = 'VIP';
            else if (totalUsage >= 10) userType = 'Activo';

            detailContent.innerHTML = `
                <div class="user-detail-avatar">
                    <div class="avatar-placeholder">${firstLetter}</div>
                </div>
                <div class="user-detail-info">
                    <div class="user-detail-item">
                        <div class="user-detail-label">Nombre de Usuario</div>
                        <div class="user-detail-value">${name}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">Correo Electrónico</div>
                        <div class="user-detail-email">
                            <span class="user-detail-email-value">${email}</span>
                            <button class="copy-email-btn" onclick="copyEmail('${email}', this)">Copiar</button>
                        </div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">Tipo de Usuario</div>
                        <div class="user-detail-value">${userType}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">Total de Controles</div>
                        <div class="user-detail-value">${totalUsage}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">Registros</div>
                        <div class="user-detail-value">${records}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">Fecha de Registro</div>
                        <div class="user-detail-value">${registrationDate}</div>
                    </div>
                </div>
            `;

            document.getElementById('user-detail-overlay').classList.add('show');
        }

        // Hide user detail modal
        function hideUserDetail() {
            document.getElementById('user-detail-overlay').classList.remove('show');
        }

        // Show impressions overlay
        function showImpressionsOverlay() {
            // Close all other overlays first
            hideUsersOverlay();
            hideUserDetail();
            hideDownloadsOverlay();
            hideAccountOverlay();
            
            document.getElementById('impressions-overlay').classList.add('show');
        }

        // Hide impressions overlay
        function hideImpressionsOverlay() {
            document.getElementById('impressions-overlay').classList.remove('show');
        }

        // Show downloads overlay
        function showDownloadsOverlay() {
            // Close all other overlays first
            hideUsersOverlay();
            hideUserDetail();
            hideImpressionsOverlay();
            hideAccountOverlay();
            
            document.getElementById('downloads-overlay').classList.add('show');
        }

        // Hide downloads overlay
        function hideDownloadsOverlay() {
            document.getElementById('downloads-overlay').classList.remove('show');
        }

        // Show account overlay
        function showAccountOverlay() {
            // Close all other overlays first
            hideUsersOverlay();
            hideUserDetail();
            hideImpressionsOverlay();
            hideDownloadsOverlay();
            
            document.getElementById('account-overlay').classList.add('show');
        }

        // Hide account overlay
        function hideAccountOverlay() {
            document.getElementById('account-overlay').classList.remove('show');
        }

        // Update impressions data - COMENTADA PORQUE AHORA USAMOS LA NUEVA API DE IMPRESIONES
        /*
        function updateImpressionsData() {
            // Calculate total impressions (using the same data as "Controles en la App")
            const selectedYear = currentSelectedDate.getFullYear();
            const selectedMonth = currentSelectedDate.getMonth();
            const firstDayOfSelectedMonth = new Date(selectedYear, selectedMonth, 1);
            const lastDayOfSelectedMonth = new Date(selectedYear, selectedMonth + 1, 0);

            const selectedMonthData = allViewsData.filter(user => {
                if (!user.Fecha || user.Fecha === '') return true;
                const userDate = new Date(user.Fecha);
                return userDate >= firstDayOfSelectedMonth && userDate <= lastDayOfSelectedMonth;
            });

            const totalImpressions = selectedMonthData.reduce((sum, user) => sum + (user.Uso || 0), 0);

            // Calculate today's impressions
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            const todayData = allViewsData.filter(user => {
                if (!user.Fecha || user.Fecha === '') return false;
                const userDate = new Date(user.Fecha);
                const userDateString = userDate.toISOString().split('T')[0];
                return userDateString === todayString;
            });

            const impressionsToday = todayData.reduce((sum, user) => sum + (user.Uso || 0), 0);

            // Calculate this week's impressions
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            const weekData = allViewsData.filter(user => {
                if (!user.Fecha || user.Fecha === '') return false;
                const userDate = new Date(user.Fecha);
                return userDate >= startOfWeek && userDate <= endOfWeek;
            });

            const impressionsWeek = weekData.reduce((sum, user) => sum + (user.Uso || 0), 0);

            // Update the display
            document.getElementById('total-impressions').textContent = totalImpressions;
            document.getElementById('impressions-month').textContent = totalImpressions;
            document.getElementById('impressions-today').textContent = impressionsToday;
            document.getElementById('impressions-week').textContent = impressionsWeek;
        }
        */


        // Show download modal
        function showDownloadModal() {
            document.getElementById('download-modal-overlay').classList.add('show');
        }

        // Hide download modal
        function hideDownloadModal() {
            document.getElementById('download-modal-overlay').classList.remove('show');
        }

        // Copy download link to clipboard
        function copyDownloadLink() {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/1RN_WlsnY5SMChRBmSJ_ruvMYLUmgUDXIPMbw3KHMJpk/export?format=csv&gid=0';
            
            try {
                // Use the modern Clipboard API if available
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(csvUrl).then(() => {
                        console.log('Enlace copiado al portapapeles');
                        showCopySuccess();
                    });
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = csvUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    console.log('Enlace copiado al portapapeles');
                    showCopySuccess();
                }
                
            } catch (err) {
                console.error('Error al copiar: ', err);
            }
        }

        // Show copy success message
        function showCopySuccess() {
            const button = event.target.closest('.download-option');
            const originalText = button.querySelector('.option-label').textContent;
            button.querySelector('.option-label').textContent = '¡Copiado!';
            button.classList.add('copied');
            
            setTimeout(() => {
                button.querySelector('.option-label').textContent = originalText;
                button.classList.remove('copied');
            }, 2000);
        }

        // Download directly
        function downloadDirectly() {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/1RN_WlsnY5SMChRBmSJ_ruvMYLUmgUDXIPMbw3KHMJpk/export?format=csv&gid=0';
            const fileName = 'Base_de_usuarios_registrados.csv';
            
            // Create a temporary anchor element to trigger download
            const link = document.createElement('a');
            link.href = csvUrl;
            link.download = fileName;
            link.target = '_blank';
            
            // Add to DOM, click, and remove
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            const button = event.target.closest('.download-option');
            const originalText = button.querySelector('.option-label').textContent;
            button.querySelector('.option-label').textContent = '¡Descargando!';
            button.style.background = '#d4edda';
            
            setTimeout(() => {
                button.querySelector('.option-label').textContent = originalText;
                button.style.background = '';
            }, 2000);
            
            // Close modal after download starts
            setTimeout(() => {
                hideDownloadModal();
            }, 1500);
            
            console.log('Descarga iniciada: Base de usuarios registrados');
        }


        // Go to home - close all modals and return to initial state
        function goToHome() {
            // Close users overlay
            hideUsersOverlay();
            
            // Close user detail modal
            hideUserDetail();
            
            // Close impressions overlay
            hideImpressionsOverlay();
            
            // Close downloads overlay
            hideDownloadsOverlay();
            
            // Close account overlay
            hideAccountOverlay();
            
            // Close download modal
            hideDownloadModal();
            
            // Reset calendar to current month
            currentSelectedDate = new Date();
            updateCalendarDisplay();
            
            // COMENTADO: No recargar datos al ir a inicio para mantener las 4 tarjetas
            /*
            // Reload data for current month
            showLoading();
            Promise.all([
                fetchData(),
                fetchViewsOrdersData(),
                fetchImpressionsData()
            ]).then(() => {
                hideLoading();
            }).catch(error => {
                console.error('Error loading home data:', error);
                hideLoading();
            });
            */
        }

        // Copy email to clipboard
        function copyEmail(email, button) {
            navigator.clipboard.writeText(email).then(() => {
                button.textContent = 'Copiado!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'Copiar';
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Error copying email:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = email;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                button.textContent = 'Copiado!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'Copiar';
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        // Close overlay when clicking outside
        document.addEventListener('click', function(event) {
            const overlay = document.getElementById('users-overlay');
            if (event.target === overlay) {
                hideUsersOverlay();
            }
            
            const detailOverlay = document.getElementById('user-detail-overlay');
            if (event.target === detailOverlay) {
                hideUserDetail();
            }
            
        const impressionsOverlay = document.getElementById('impressions-overlay');
        if (event.target === impressionsOverlay) {
            hideImpressionsOverlay();
        }
        
        const downloadsOverlay = document.getElementById('downloads-overlay');
        if (event.target === downloadsOverlay) {
            hideDownloadsOverlay();
        }
        
        const accountOverlay = document.getElementById('account-overlay');
        if (event.target === accountOverlay) {
            hideAccountOverlay();
        }
        
        const downloadModalOverlay = document.getElementById('download-modal-overlay');
        if (event.target === downloadModalOverlay) {
            hideDownloadModal();
        }
        });

        // Close overlay with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                hideUsersOverlay();
                hideUserDetail();
                hideImpressionsOverlay();
                hideDownloadsOverlay();
                hideAccountOverlay();
                hideDownloadModal();
            }
        });

        // Function to fetch data from main API
        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                const result = await response.json();
                
                if (result.success && result.data) {
                    calculateMetrics(result.data);
                } else {
                    console.error('Error fetching data:', result);
                    showErrorState();
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showErrorState();
            }
        }

        // Function to fetch impressions data from impressions API
        async function fetchImpressionsData() {
            console.log('=== CARGANDO IMPRESIONES ===');
            console.log('URL de impresiones:', API_IMPRESSIONS_URL);
            try {
                const response = await fetch(API_IMPRESSIONS_URL);
                console.log('Respuesta de impresiones:', response);
                const result = await response.json();
                console.log('Datos de impresiones recibidos:', result);
                
                if (result.success && result.data) {
                    allImpressionsData = result.data; // guardar globalmente
                    calculateImpressions(result.data);
                    // actualizar vistas hoy desde impresiones usando Entradas
                    updateTodayViewsFromImpressions();
                    // actualizar entradas del mes
                    console.log('Llamando updateConversionRate después de cargar impresiones...');
                    setTimeout(updateConversionRate, 100);
                } else {
                    console.error('Error fetching impressions data:', result);
                }
            } catch (error) {
                console.error('Error fetching impressions data:', error);
            }
        }

        function updateTodayViewsFromImpressions() {
            const today = new Date();
            const toLocalYMD = (d) => {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            };
            const todayLocal = toLocalYMD(today);
            const todayData = (allImpressionsData || []).filter(entry => {
                if (!entry.Fecha || entry.Fecha === '') return false;
                const d = new Date(entry.Fecha);
                return toLocalYMD(d) === todayLocal;
            });
            const todayViews = todayData.reduce((sum, entry) => sum + (entry.Entradas || 0), 0);
            console.log('Vistas hoy desde impresiones (Entradas):', todayViews);
            
            // Update DOM
            const viewsElement = document.getElementById('today-views');
            const changeElement = document.getElementById('today-views-change');
            if (viewsElement) viewsElement.textContent = todayViews;
            if (changeElement) changeElement.textContent = '+12.3%'; // Por ahora valor fijo
        }

        // Calculate impressions from the impressions API
        function calculateImpressions(data) {
            console.log('=== CALCULANDO IMPRESIONES ===');
            console.log('Datos de impresiones:', data);
            console.log('Total entradas:', data.length);
            
            // Get selected date and first day of selected month
            const selectedYear = currentSelectedDate.getFullYear();
            const selectedMonth = currentSelectedDate.getMonth();
            const firstDayOfSelectedMonth = new Date(selectedYear, selectedMonth, 1);
            const lastDayOfSelectedMonth = new Date(selectedYear, selectedMonth + 1, 0);

            console.log('Mes seleccionado:', selectedMonth + 1, 'Año:', selectedYear);
            console.log('Primer día:', firstDayOfSelectedMonth);
            console.log('Último día:', lastDayOfSelectedMonth);

            // Calculate total impressions (all time - sum values, not count records)
            const totalImpressions = data.reduce((sum, entry) => sum + (entry.Impresiones || 0), 0);

            // Filter impressions for selected month and sum values
            const selectedMonthImpressions = data.filter(entry => {
                if (!entry.Fecha || entry.Fecha === '') return false;
                const entryDate = new Date(entry.Fecha);
                const isInMonth = entryDate >= firstDayOfSelectedMonth && entryDate <= lastDayOfSelectedMonth;
                const hasImpressions = entry.Impresiones > 0;
                console.log('Entry:', entry.Fecha, 'Impresiones:', entry.Impresiones, 'InMonth:', isInMonth, 'HasImpressions:', hasImpressions);
                return isInMonth && hasImpressions;
            });
            
            // Sum the impression values for the month
            const selectedMonthImpressionsSum = selectedMonthImpressions.reduce((sum, entry) => sum + (entry.Impresiones || 0), 0);

            // Calculate today's impressions using local date
            const today = new Date();
            const toLocalYMD = (d) => {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            };
            const todayLocal = toLocalYMD(today);
            const todayImpressions = data.filter(entry => {
                if (!entry.Fecha || entry.Fecha === '') return false;
                const entryDate = new Date(entry.Fecha);
                const entryDateLocal = toLocalYMD(entryDate);
                return entryDateLocal === todayLocal && entry.Impresiones > 0;
            });

            // Calculate this week's impressions
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            const weekImpressions = data.filter(entry => {
                if (!entry.Fecha || entry.Fecha === '') return false;
                const entryDate = new Date(entry.Fecha);
                return entryDate >= startOfWeek && entryDate <= endOfWeek && entry.Impresiones > 0;
            });
            
            console.log('Total impresiones (todas):', totalImpressions);
            console.log('Impresiones del mes (suma):', selectedMonthImpressionsSum);
            console.log('Impresiones de hoy:', todayImpressions.length);
            console.log('Impresiones de la semana:', weekImpressions.length);
            console.log('=== DEBUG IMPRESIONES DEL MES ===');
            console.log('Mes seleccionado:', selectedMonth + 1, 'Año:', selectedYear);
            console.log('Rango del mes:', firstDayOfSelectedMonth, 'a', lastDayOfSelectedMonth);
            console.log('Datos filtrados del mes:', selectedMonthImpressions);
            
            // Update the display
            const totalElement = document.getElementById('total-impressions');
            const monthElement = document.getElementById('impressions-month');
            const todayElement = document.getElementById('impressions-today');
            const weekElement = document.getElementById('impressions-week');
            
            console.log('Elementos encontrados:');
            console.log('total-impressions:', totalElement);
            console.log('impressions-month:', monthElement);
            console.log('impressions-today:', todayElement);
            console.log('impressions-week:', weekElement);
            
            if (totalElement) {
                totalElement.textContent = totalImpressions;
                console.log('total-impressions actualizado a:', totalImpressions);
            } else {
                console.error('No se encontró el elemento total-impressions');
            }
            
            if (monthElement) monthElement.textContent = selectedMonthImpressionsSum;
            if (todayElement) todayElement.textContent = todayImpressions.length;
            if (weekElement) weekElement.textContent = weekImpressions.length;
            
            // Update the "Activos" card with monthly impressions
            const ordersElement = document.getElementById('total-orders');
            if (ordersElement) {
                ordersElement.textContent = selectedMonthImpressionsSum;
                console.log('total-orders (impresiones mensuales) actualizado a:', selectedMonthImpressionsSum);
                // Update the percentage change for orders
                updateChangePercentage('orders', selectedMonthImpressionsSum);
            }
            
            // Update the "today-users" card with today's impressions
            const todayUsersElement = document.getElementById('today-users');
            if (todayUsersElement) {
                todayUsersElement.textContent = todayImpressions.length;
                console.log('today-users (impresiones de hoy) actualizado a:', todayImpressions.length);
            }
            
            console.log('=== IMPRESIONES ACTUALIZADAS ===');
        }

        // Function to fetch views and orders data from specific API
        async function fetchViewsOrdersData() {
            try {
                // Add timestamp to prevent caching
                const urlWithTimestamp = API_VIEWS_ORDERS_URL + '&t=' + Date.now();
                const response = await fetch(urlWithTimestamp);
                const result = await response.json();
                
                if (result.success && result.data) {
                    allViewsData = result.data; // Store data globally
                    calculateViewsAndOrders(result.data);
                    updateTodayStats(result.data); // Update today's stats
                    // Update calendar after data is loaded
                    updateCalendarDisplay();
                } else {
                    console.error('Error fetching views/orders data:', result);
                    document.getElementById('total-views').textContent = 'Error';
                    document.getElementById('views-change').textContent = 'N/A';
                    document.getElementById('total-orders').textContent = 'Error';
                    document.getElementById('orders-change').textContent = 'N/A';
                }
            } catch (error) {
                console.error('Error fetching views/orders data:', error);
                document.getElementById('total-views').textContent = 'Error';
                document.getElementById('views-change').textContent = 'N/A';
                document.getElementById('total-orders').textContent = 'Error';
                document.getElementById('orders-change').textContent = 'N/A';
            }
        }

        // Calculate views and orders from the specific API
        function calculateViewsAndOrders(data) {
            console.log('=== VERIFICACIÓN DE API ===');
            console.log('Total registros en API:', data.length);
            console.log('Datos completos de la API:', data);
            
            // Extract available months from data
            extractAvailableMonths(data);
            
            // Get selected date and first day of selected month
            const selectedYear = currentSelectedDate.getFullYear();
            const selectedMonth = currentSelectedDate.getMonth();
            const firstDayOfSelectedMonth = new Date(selectedYear, selectedMonth, 1);
            const lastDayOfSelectedMonth = new Date(selectedYear, selectedMonth + 1, 0);
            
            console.log('Mes seleccionado en calendario:', selectedMonth + 1, 'Año:', selectedYear);
            console.log('Primer día del mes seleccionado:', firstDayOfSelectedMonth);
            console.log('Último día del mes seleccionado:', lastDayOfSelectedMonth);
            
            // Filter data from selected month
            const selectedMonthData = data.filter(user => {
                // If no date or empty date, skip it for month filtering
                if (!user.Fecha || user.Fecha === '') {
                    console.log('Registro sin fecha omitido:', user);
                    return false;
                }
                const userDate = new Date(user.Fecha);
                const isInSelectedMonth = userDate >= firstDayOfSelectedMonth && userDate <= lastDayOfSelectedMonth;
                console.log(`Fecha: ${user.Fecha} -> ${userDate} -> En mes seleccionado: ${isInSelectedMonth}`);
                return isInSelectedMonth;
            });
            
            console.log('Registros filtrados para el mes seleccionado:', selectedMonthData.length);
            console.log('Datos filtrados del mes seleccionado:', selectedMonthData);
            
            // Calculate total views (sum of all usage from selected month)
            let totalViews = 0;
            selectedMonthData.forEach((user, index) => {
                const uso = parseInt(user.Uso) || 0;
                console.log(`Registro mes seleccionado ${index + 1}: ${user.Nombre}, Uso: ${uso}, Fecha: ${user.Fecha}`);
                totalViews += uso;
            });
            
            // Calculate unique main emails (active users from selected month)
            const uniqueMainEmails = new Set(selectedMonthData.map(user => extractMainEmail(user.Correo)));
            const activeUsers = uniqueMainEmails.size;
            
            console.log('Total visitas del mes seleccionado:', totalViews);
            console.log('Usuarios activos únicos del mes seleccionado:', activeUsers);
            
            // Update views
            document.getElementById('total-views').textContent = totalViews;
            updateChangePercentage('views', totalViews);
            
            // Update orders - COMENTADO PORQUE AHORA SE ACTUALIZA DESDE LA API DE IMPRESIONES
            // document.getElementById('total-orders').textContent = activeUsers;
            // updateChangePercentage('orders', activeUsers);
            
            // Update top user
            updateTopUser(data);
            
            // Update conversion rate after both visitors and orders are loaded
            setTimeout(updateConversionRate, 100);
        }

        // Extract available months from data
        function extractAvailableMonths(data) {
            availableMonths.clear();
            data.forEach(user => {
                if (user.Fecha && user.Fecha !== '') {
                    const userDate = new Date(user.Fecha);
                    const monthKey = `${userDate.getFullYear()}-${userDate.getMonth()}`;
                    availableMonths.add(monthKey);
                    console.log('Agregando mes:', monthKey, 'Fecha:', user.Fecha, 'Usuario:', user.Nombre);
                }
            });
            console.log('Meses disponibles totales:', Array.from(availableMonths));
        }

        // Format month name in Spanish
        function formatMonthName(date) {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            return `${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        // Update calendar display
        function updateCalendarDisplay() {
            document.getElementById('current-month').textContent = formatMonthName(currentSelectedDate);
            
            // Check if previous/next months are available
            const prevMonth = new Date(currentSelectedDate.getFullYear(), currentSelectedDate.getMonth() - 1);
            const nextMonth = new Date(currentSelectedDate.getFullYear(), currentSelectedDate.getMonth() + 1);
            
            const prevMonthKey = `${prevMonth.getFullYear()}-${prevMonth.getMonth()}`;
            const nextMonthKey = `${nextMonth.getFullYear()}-${nextMonth.getMonth()}`;
            
            document.getElementById('prev-month').disabled = !availableMonths.has(prevMonthKey);
            document.getElementById('next-month').disabled = !availableMonths.has(nextMonthKey);
        }

        // Navigate to previous month
        function goToPreviousMonth() {
            const prevMonth = new Date(currentSelectedDate.getFullYear(), currentSelectedDate.getMonth() - 1);
            const prevMonthKey = `${prevMonth.getFullYear()}-${prevMonth.getMonth()}`;
            
            if (availableMonths.has(prevMonthKey)) {
                console.log('=== NAVEGANDO AL MES ANTERIOR ===');
                console.log('Mes actual:', formatMonthName(currentSelectedDate));
                console.log('Navegando a:', formatMonthName(prevMonth));
                console.log('Datos guardados antes del cambio:', previousMonthData);
                
                // Show loading spinner
                showLoading();
                
                // Save current month data before navigating
                saveCurrentMonthData();
                
                currentSelectedDate = prevMonth;
                updateCalendarDisplay();
                
                // Refresh data for the new month
                Promise.all([
                    fetchData(), // Update users registered
                    fetchViewsOrdersData(), // Update views and active users
                    fetchImpressionsData() // Update impressions
                ]).then(() => {
                    hideLoading();
                }).catch(error => {
                    console.error('Error loading data:', error);
                    hideLoading();
                });
            }
        }

        // Navigate to next month
        function goToNextMonth() {
            const nextMonth = new Date(currentSelectedDate.getFullYear(), currentSelectedDate.getMonth() + 1);
            const nextMonthKey = `${nextMonth.getFullYear()}-${nextMonth.getMonth()}`;
            
            if (availableMonths.has(nextMonthKey)) {
                console.log('=== NAVEGANDO AL MES SIGUIENTE ===');
                console.log('Mes actual:', formatMonthName(currentSelectedDate));
                console.log('Navegando a:', formatMonthName(nextMonth));
                console.log('Datos guardados antes del cambio:', previousMonthData);
                
                // Show loading spinner
                showLoading();
                
                // Save current month data before navigating
                saveCurrentMonthData();
                
                currentSelectedDate = nextMonth;
                updateCalendarDisplay();
                
                // Refresh data for the new month
                Promise.all([
                    fetchData(), // Update users registered
                    fetchViewsOrdersData(), // Update views and active users
                    fetchImpressionsData() // Update impressions
                ]).then(() => {
                    hideLoading();
                }).catch(error => {
                    console.error('Error loading data:', error);
                    hideLoading();
                });
            }
        }

        // Save current month data for comparison
        function saveCurrentMonthData() {
            const visitors = parseInt(document.getElementById('total-visitors').textContent) || 0;
            const orders = parseInt(document.getElementById('total-orders').textContent) || 0;
            const views = parseInt(document.getElementById('total-views').textContent) || 0;
            const entries = parseInt(document.getElementById('conversion-rate').textContent) || 0;
            
            previousMonthData = {
                visitors: visitors,
                orders: orders,
                views: views,
                entries: entries
            };
            
            currentMonthKey = `${currentSelectedDate.getFullYear()}-${currentSelectedDate.getMonth()}`;
            
            console.log('=== GUARDANDO DATOS DEL MES ACTUAL ===');
            console.log('Mes guardado:', formatMonthName(currentSelectedDate));
            console.log('Clave del mes:', currentMonthKey);
            console.log('Datos guardados:', previousMonthData);
        }

        // Extract main email (before first underscore)
        function extractMainEmail(email) {
            return email.split('_')[0];
        }

        // Loading spinner functions
        function showLoading() {
            // Show all card spinners
            document.getElementById('loading-visitors').classList.add('show');
            document.getElementById('loading-orders').classList.add('show');
            document.getElementById('loading-views').classList.add('show');
            document.getElementById('loading-conversion').classList.add('show');
        }

        function hideLoading() {
            // Hide all card spinners
            document.getElementById('loading-visitors').classList.remove('show');
            document.getElementById('loading-orders').classList.remove('show');
            document.getElementById('loading-views').classList.remove('show');
            document.getElementById('loading-conversion').classList.remove('show');
        }

        // Today's stats functions
        function updateTodayStats(data) {
            console.log('Actualizando estadísticas de hoy...');
            
            // Get today's date from device
            const today = new Date();
            const todayString = today.toISOString().split('T')[0]; // YYYY-MM-DD format
            
            // Update today's date display
            const todayDateElement = document.getElementById('today-date');
            const options = { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            };
            todayDateElement.textContent = today.toLocaleDateString('es-ES', options);
            
            // Filter data for today
            const todayData = data.filter(user => {
                if (!user.Fecha || user.Fecha === '') return false;
                const userDate = new Date(user.Fecha);
                // Build local YYYY-MM-DD for both today and the user date
                const toLocalYMD = (d) => {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${y}-${m}-${day}`;
                };
                const userLocal = toLocalYMD(userDate);
                const todayLocal = toLocalYMD(today);
                return userLocal === todayLocal;
            });
            
            console.log(`Datos de hoy (${todayString}):`, todayData.length, 'registros');
            
            // Calculate today's views (sum of all "Uso" values)
            const todayViews = todayData.reduce((sum, user) => sum + (user.Uso || 0), 0);
            
            // Calculate unique active users today
            const todayUniqueUsers = new Set(todayData.map(user => extractMainEmail(user.Correo)));
            const todayActiveUsers = todayUniqueUsers.size;
            
            // Update DOM
            // document.getElementById('today-views').textContent = todayViews; // COMENTADO - AHORA SE ACTUALIZA DESDE API DE IMPRESIONES
            // document.getElementById('today-users').textContent = todayActiveUsers; // COMENTADO - AHORA SE ACTUALIZA CON IMPRESIONES
            
            // Calculate changes compared to yesterday
            calculateTodayChanges(todayViews, todayActiveUsers);
        }

        function calculateTodayChanges(todayViews, todayActiveUsers) {
            // Get yesterday's date
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayString = yesterday.toISOString().split('T')[0];
            
            // For now, show default positive changes
            // In a real implementation, you'd fetch yesterday's data for comparison
            // document.getElementById('today-views-change').textContent = '+12.3%'; // COMENTADO - AHORA SE ACTUALIZA DESDE API DE IMPRESIONES
            // document.getElementById('today-users-change').textContent = '+8.7%'; // COMENTADO - AHORA SE ACTUALIZA CON IMPRESIONES
            
            console.log('Cambios de hoy vs ayer:');
            console.log('Vistas hoy:', todayViews, 'Cambio: +12.3%');
            console.log('Usuarios hoy:', todayActiveUsers, 'Cambio: +8.7%');
        }

        function updateTopUser(data) {
            console.log('Actualizando usuario destacado...');
            
            const selectedYear = currentSelectedDate.getFullYear();
            const selectedMonth = currentSelectedDate.getMonth();
            const firstDayOfSelectedMonth = new Date(selectedYear, selectedMonth, 1);
            const lastDayOfSelectedMonth = new Date(selectedYear, selectedMonth + 1, 0);

            const selectedMonthData = data.filter(user => {
                if (!user.Fecha || user.Fecha === '') return true; // Include users without date
                const userDate = new Date(user.Fecha);
                return userDate >= firstDayOfSelectedMonth && userDate <= lastDayOfSelectedMonth;
            });

            console.log(`Datos del mes seleccionado (${formatMonthName(currentSelectedDate)}):`, selectedMonthData.length, 'registros');

            // Calculate usage per user for selected month
            const userUsageMap = new Map();
            
            selectedMonthData.forEach(user => {
                const mainEmail = extractMainEmail(user.Correo);
                const usage = user.Uso || 0;
                
                if (userUsageMap.has(mainEmail)) {
                    userUsageMap.set(mainEmail, userUsageMap.get(mainEmail) + usage);
                } else {
                    userUsageMap.set(mainEmail, usage);
                }
            });

            // Find user with highest usage
            let topUser = null;
            let maxUsage = 0;
            let topUserEmail = '';

            userUsageMap.forEach((usage, email) => {
                if (usage > maxUsage) {
                    maxUsage = usage;
                    topUserEmail = email;
                }
            });

            // If no data for selected month, get global top user
            if (maxUsage === 0 || !topUserEmail) {
                console.log('No hay datos para el mes seleccionado, buscando usuario más activo globalmente...');
                
                // Calculate global usage per user
                const globalUserUsageMap = new Map();
                
                data.forEach(user => {
                    const mainEmail = extractMainEmail(user.Correo);
                    const usage = user.Uso || 0;
                    
                    if (globalUserUsageMap.has(mainEmail)) {
                        globalUserUsageMap.set(mainEmail, globalUserUsageMap.get(mainEmail) + usage);
                    } else {
                        globalUserUsageMap.set(mainEmail, usage);
                    }
                });

                // Find global top user
                globalUserUsageMap.forEach((usage, email) => {
                    if (usage > maxUsage) {
                        maxUsage = usage;
                        topUserEmail = email;
                    }
                });

                // Find the first record of the global top user
                if (topUserEmail) {
                    topUser = data.find(user => extractMainEmail(user.Correo) === topUserEmail);
                }
            } else {
                // Find the first record of the selected month top user
                topUser = selectedMonthData.find(user => extractMainEmail(user.Correo) === topUserEmail);
            }

            // Update the UI
            if (topUser && maxUsage > 0) {
                const userName = topUser.Nombre || 'Usuario Anónimo';
                const userEmail = topUserEmail;
                
                // Determine user type based on usage
                let userType = 'Básico';
                if (maxUsage >= 100) userType = 'Premium';
                else if (maxUsage >= 50) userType = 'VIP';
                else if (maxUsage >= 10) userType = 'Activo';

                // Calculate score (max 5.0, based on usage)
                const score = Math.min(5.0, Math.max(1.0, (maxUsage / 20) + 1));

                document.getElementById('top-user-name').textContent = userName;
                document.getElementById('top-user-type').textContent = `${userType}. ${maxUsage} Controles`;
                document.getElementById('top-user-score').textContent = score.toFixed(1);
                document.getElementById('top-user-usage').textContent = `(Nivel ${userType})`;
                document.getElementById('top-user-status').textContent = 'Muy Activo';

                console.log('Usuario destacado actualizado:');
                console.log('Nombre:', userName);
                console.log('Email:', userEmail);
                console.log('Controles:', maxUsage);
                console.log('Tipo:', userType);
                console.log('Score:', score.toFixed(1));
            } else {
                // No data available
                document.getElementById('top-user-name').textContent = 'Sin datos';
                document.getElementById('top-user-type').textContent = 'No hay usuarios';
                document.getElementById('top-user-score').textContent = '0.0';
                document.getElementById('top-user-usage').textContent = '(0 controles)';
                document.getElementById('top-user-status').textContent = 'No disponible';

                console.log('No hay usuarios destacados disponibles');
            }
        }

        // Calculate metrics from API data
        function calculateMetrics(data) {
            console.log('Datos de la API principal (usuarios registrados):', data);
            
            // Filter data by selected month (same logic as calculateViewsAndOrders)
            const selectedYear = currentSelectedDate.getFullYear();
            const selectedMonth = currentSelectedDate.getMonth();
            const firstDayOfSelectedMonth = new Date(selectedYear, selectedMonth, 1);
            const lastDayOfSelectedMonth = new Date(selectedYear, selectedMonth + 1, 0);

            const selectedMonthData = data.filter(user => {
                if (!user.Fecha || user.Fecha === '') return true; // Include users with empty dates in current month
                const userDate = new Date(user.Fecha);
                return userDate >= firstDayOfSelectedMonth && userDate <= lastDayOfSelectedMonth;
            });

            console.log('Mes seleccionado para usuarios registrados:', selectedYear, selectedMonth);
            console.log('Datos filtrados del mes seleccionado (usuarios):', selectedMonthData.length);
            
            // Calculate unique main emails (visitors) from filtered data
            const uniqueMainEmails = new Set(selectedMonthData.map(user => extractMainEmail(user.Correo)));
            const uniqueEmailsCount = uniqueMainEmails.size;
            
            console.log('Total usuarios registrados del mes:', uniqueEmailsCount);
            
            // Update DOM with calculated metrics
            document.getElementById('total-visitors').textContent = uniqueEmailsCount;
            updateChangePercentage('visitors', uniqueEmailsCount);
            
            // Update conversion rate after visitors data is loaded
            setTimeout(updateConversionRate, 100);
        }

        // Update metrics in the DOM
        function updateMetrics(metrics) {
            // Total Visitors
            document.getElementById('total-visitors').textContent = metrics.visitors;
            updateChangePercentage('visitors', metrics.visitors);
            
            // Update conversion rate after visitors data is loaded
            setTimeout(updateConversionRate, 100);
            
            // Update trend colors based on actual data
            updateTrendColors();
        }

        // Update change percentage for any metric
        function updateChangePercentage(metricType, currentValue) {
            const newMonthKey = `${currentSelectedDate.getFullYear()}-${currentSelectedDate.getMonth()}`;
            
            console.log(`=== ACTUALIZANDO ${metricType.toUpperCase()} ===`);
            console.log('Valor actual:', currentValue);
            console.log('Valor anterior guardado:', previousMonthData[metricType]);
            console.log('Mes actual:', formatMonthName(currentSelectedDate));
            console.log('Clave del mes actual:', newMonthKey);
            console.log('Clave del mes anterior guardado:', currentMonthKey);
            
            let changeText = '+0%';
            let isPositive = true;
            
            // Only compare if we have previous data AND we're going FORWARD in time (not backward)
            if (previousMonthData[metricType] > 0 && currentMonthKey && currentMonthKey !== newMonthKey) {
                const currentMonth = currentSelectedDate.getMonth();
                const currentYear = currentSelectedDate.getFullYear();
                const previousMonth = new Date(currentMonthKey.split('-')[0], currentMonthKey.split('-')[1]);
                
                // Only compare if current month is AFTER the previous month (only newer months compare with older ones)
                if (currentSelectedDate > previousMonth) {
                    // Compare with previous month data
                    const change = ((currentValue - previousMonthData[metricType]) / previousMonthData[metricType] * 100).toFixed(1);
                    changeText = (change >= 0 ? '+' : '') + change + '%';
                    isPositive = parseFloat(change) >= 0;
                    
                    console.log(`CÁLCULO REAL - Cambio en ${metricType}:`, changeText, 'Positivo:', isPositive);
                    console.log(`Progresión hacia adelante: ${formatMonthName(previousMonth)} → ${formatMonthName(currentSelectedDate)}`);
                    console.log(`Fórmula: (${currentValue} - ${previousMonthData[metricType]}) / ${previousMonthData[metricType]} * 100 = ${change}%`);
                } else {
                    // Going backward in time, use default values
                    const defaultValues = {
                        visitors: '+12.5%',
                        orders: '+8.3%',
                        views: '+15.2%',
                        entries: '+2.5%'
                    };
                    changeText = defaultValues[metricType] || '+0%';
                    isPositive = true;
                    console.log(`PROGRESIÓN HACIA ATRÁS - ${formatMonthName(currentSelectedDate)} no compara con ${formatMonthName(previousMonth)}, mostrando:`, changeText);
                }
            } else {
                // No previous data or same month, show positive default
                const defaultValues = {
                    visitors: '+12.5%',
                    orders: '+8.3%',
                    views: '+15.2%',
                    entries: '+2.5%'
                };
                changeText = defaultValues[metricType] || '+0%';
                isPositive = true;
                console.log(`VALOR POR DEFECTO - ${!previousMonthData[metricType] ? 'Sin datos previos' : 'Mismo mes o primera vez'} para ${metricType}, mostrando:`, changeText);
            }
            
        // Update text and color with arrow
        const elementId = metricType === 'entries' ? 'conversion-change' : `${metricType}-change`;
        const changeElement = document.getElementById(elementId);
        const arrow = isPositive ? '▲' : '▲';
        changeElement.textContent = arrow + ' ' + changeText;
            
            // Update parent container color
            const parentContainer = changeElement.closest('.metric-change');
            if (parentContainer) {
                if (isPositive) {
                    parentContainer.classList.remove('negative');
                    parentContainer.classList.add('positive');
                } else {
                    parentContainer.classList.remove('positive');
                    parentContainer.classList.add('negative');
                }
            }
            
            console.log(`=== FIN ACTUALIZACIÓN ${metricType.toUpperCase()} ===`);
        }

        // Store previous month data for comparison
        let previousMonthData = {
            visitors: 0,
            orders: 0,
            views: 0,
            entries: 0
        };
        
        // Track current month to prevent self-comparison
        let currentMonthKey = null;

        // Update conversion rate when both visitors and orders data are available
        function updateConversionRate() {
            console.log('=== ACTUALIZANDO ENTRADAS DEL MES ===');
            console.log('allImpressionsData disponible:', !!allImpressionsData);
            console.log('Cantidad de datos:', allImpressionsData ? allImpressionsData.length : 0);
            
            // Calculate monthly app entries using the same API as "Entradas al App Hoy"
            if (!allImpressionsData || allImpressionsData.length === 0) {
                console.log('No hay datos de impresiones para calcular entradas del mes');
                document.getElementById('conversion-rate').textContent = '0';
                updateChangePercentage('entries', 0);
                return;
            }

            // Get selected date and first day of selected month
            const selectedYear = currentSelectedDate.getFullYear();
            const selectedMonth = currentSelectedDate.getMonth();
            const firstDayOfSelectedMonth = new Date(selectedYear, selectedMonth, 1);
            const lastDayOfSelectedMonth = new Date(selectedYear, selectedMonth + 1, 0);

            console.log('Mes seleccionado:', selectedMonth + 1, 'Año:', selectedYear);
            console.log('Rango de fechas:', firstDayOfSelectedMonth, 'a', lastDayOfSelectedMonth);
            
            // Filter data for selected month
            const selectedMonthData = allImpressionsData.filter(entry => {
                if (!entry.Fecha || entry.Fecha === '') return false;
                const entryDate = new Date(entry.Fecha);
                const isInRange = entryDate >= firstDayOfSelectedMonth && entryDate <= lastDayOfSelectedMonth;
                console.log(`Entry: ${entry.Fecha} -> ${entryDate} -> En rango: ${isInRange}, Entradas: ${entry.Entradas || 0}`);
                return isInRange;
            });

            console.log('Datos filtrados del mes:', selectedMonthData.length, 'registros');
            
            // Sum all "Entradas" for the selected month
            const monthlyEntries = selectedMonthData.reduce((sum, entry) => sum + (entry.Entradas || 0), 0);
            
            console.log('Total entradas del mes seleccionado:', monthlyEntries);
            
            // Update DOM
            document.getElementById('conversion-rate').textContent = monthlyEntries;
            console.log('DOM actualizado con valor:', monthlyEntries);
            
            // Use the centralized comparison function
            updateChangePercentage('entries', monthlyEntries);
        }

        // Update trend colors based on data
        function updateTrendColors() {
            const changes = document.querySelectorAll('.metric-change');
            changes.forEach(change => {
                const value = change.querySelector('span').textContent;
                if (value.includes('-')) {
                    change.classList.remove('positive');
                    change.classList.add('negative');
                } else {
                    change.classList.remove('negative');
                    change.classList.add('positive');
                }
            });
        }

        // Show error state when API fails
        function showErrorState() {
            document.getElementById('total-visitors').textContent = 'Error';
            document.getElementById('total-orders').textContent = 'Error';
            document.getElementById('total-views').textContent = 'Error';
            document.getElementById('conversion-rate').textContent = 'Error';
            
            document.getElementById('visitors-change').textContent = 'N/A';
            document.getElementById('orders-change').textContent = 'N/A';
            document.getElementById('views-change').textContent = 'N/A';
            document.getElementById('conversion-change').textContent = 'N/A';
        }

        function refreshData() {
            console.log('Actualizando datos...');
            showLoading();
            
            Promise.all([
                fetchData(),
                fetchViewsOrdersData(),
                fetchImpressionsData()
            ]).then(() => {
                hideLoading();
                console.log('Datos actualizados correctamente');
                
                // Agregar animación de rotación al icono
                const refreshIcon = document.querySelector('.refresh-icon::before');
                const refreshIconElement = document.querySelector('.refresh-icon');
                if (refreshIconElement) {
                    refreshIconElement.style.animation = 'spin 1s ease-in-out';
                    setTimeout(() => {
                        refreshIconElement.style.animation = '';
                    }, 1000);
                }
            }).catch(error => {
                console.error('Error actualizando datos:', error);
                hideLoading();
            });
        }

        // Funcionalidad para los botones de período
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.period-btn').forEach(b => {
                    b.classList.remove('active');
                    b.style.background = '#f0f0f0';
                    b.style.color = '#666';
                });
                this.classList.add('active');
                this.style.background = '#333';
                this.style.color = 'white';
            });
        });

        // Funcionalidad para la navegación
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize calendar
            updateCalendarDisplay();
            
            // Add event listeners for calendar navigation
            document.getElementById('prev-month').addEventListener('click', goToPreviousMonth);
            document.getElementById('next-month').addEventListener('click', goToNextMonth);
            
            // Show loading spinner for initial load
            showLoading();
            
            // Load initial data
            Promise.all([
                fetchData(), // Load main metrics (visitors)
                fetchViewsOrdersData(), // Load views and orders data from same API
                fetchImpressionsData() // Load impressions data
            ]).then(() => {
                // Load users data for overlay
                populateUsersGrid();
                hideLoading();
            }).catch(error => {
                console.error('Error loading initial data:', error);
                hideLoading();
            });
            
            // Data only loads when navigating between months or on page load
        });
    </script>
    <script>
        // Simple localStorage cache for static assets (no HTML or API data)
        (function () {
            const STATIC_CACHE_FLAG = 'admin_static_cached_v1';
            const STATIC_ASSETS = [
                'images/icon1_00000.png',
                'images/icon2_00000.png',
                'images/icon3_00000.png',
                'images/icon4_00000.png',
                'images/icon5_00000.png',
                'images/s.png',
                'images/estrella.png'
            ];

            async function cacheAssetToBase64(url) {
                try {
                    const response = await fetch(url, { cache: 'reload' });
                    const blob = await response.blob();
                    const reader = new FileReader();
                    return await new Promise((resolve) => {
                        reader.onload = () => {
                            localStorage.setItem(`admin_cache_${url}`, reader.result);
                            resolve(true);
                        };
                        reader.readAsDataURL(blob);
                    });
                } catch (_) {
                    return false;
                }
            }

            function getCached(url) {
                return localStorage.getItem(`admin_cache_${url}`);
            }

            function swapImagesWithCache() {
                document.querySelectorAll('img').forEach(img => {
                    const cached = getCached(img.getAttribute('src')) || getCached(img.src);
                    if (cached) img.src = cached;
                });
            }

            document.addEventListener('DOMContentLoaded', async function () {
                // If first time, cache static assets
                if (!localStorage.getItem(STATIC_CACHE_FLAG)) {
                    for (const asset of STATIC_ASSETS) {
                        // eslint-disable-next-line no-await-in-loop
                        await cacheAssetToBase64(asset);
                    }
                    localStorage.setItem(STATIC_CACHE_FLAG, 'true');
                }
                // Always try to swap after DOM is ready
                swapImagesWithCache();
            });
        })();
    </script>
</body>
</html>
